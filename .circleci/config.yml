version: 2.1

jobs:
  retrain:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout

      - run:
          name: Install Dependencies
          command: |
            pip install --upgrade pip
            pip install -r requirements.txt

      - run:
          name: Set Git Identity
          command: |
            git config --global user.email "circleci@smartfarming.ai"
            git config --global user.name "CircleCI Auto Bot"

      - run:
          name: Sync Repo
          command: |
            git fetch --all
            git reset --hard origin/main
            git pull --rebase

      - run:
          name: Retrain Models
          command: |
            echo "===== Running nightly retrain ====="
            python3 -m mlops.retrain_all

      - run:
          name: Debug Git Status
          command: |
            echo "===== Files changed ====="
            git status
            ls -R models/

      - run:
          name: Commit Model Updates
          command: |
            git add models/ || true
            git add mlops/last_metrics.json || true

            if git diff --cached --quiet; then
                echo "No changes to commit."
            else
                git commit -m "Nightly Auto Retrain: $(date '+%Y-%m-%d %H:%M:%S')"
            fi

      - run:
          name: Push to GitHub
          command: |
            git push https://${GITHUB_TOKEN}@github.com/Harshavardhan200/Smart-Farming-AI-System.git || {
              echo "Git push failed. Retrying with --force...";
              git push --force https://${GITHUB_TOKEN}@github.com/Harshavardhan200/Smart-Farming-AI-System.git;
            }

workflows:
  nightly_training:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - retrain

  manual_training:
    jobs:
      - retrain
